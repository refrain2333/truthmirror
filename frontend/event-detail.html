<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‹ä»¶è¯¦æƒ… - çœŸç›¸ä¹‹é•œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }



        /* ä¸»è¦å†…å®¹ */
        main {
            padding: 40px 0;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 32px;
            margin: 20px 0;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .event-detail {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);        }

        .event-header {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .event-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .status-pending { 
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%); 
            color: #92400e; 
        }
        .status-nominated { 
            background: linear-gradient(135deg, #dbeafe 0%, #3b82f6 100%); 
            color: #1e40af; 
        }
        .status-processing { 
            background: linear-gradient(135deg, #fed7d7 0%, #f56565 100%); 
            color: #c53030; 
        }
        .status-voting { 
            background: linear-gradient(135deg, #d1fae5 0%, #10b981 100%); 
            color: #047857; 
        }
        .status-confirmed { 
            background: linear-gradient(135deg, #e2e8f0 0%, #64748b 100%); 
            color: #334155; 
        }
        .event-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .event-meta {
            display: flex;
            gap: 30px;
            color: #666;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .event-content {
            padding: 30px;
        }

        .event-description {
            font-size: 16px;
            line-height: 1.7;
            color: #444;
            margin-bottom: 30px;
        }

        /* æŠ•ç¥¨åŒºåŸŸ */
        .voting-section {
            background: #f8f9fa;
            padding: 25px 30px;
            border-top: 1px solid #eee;
        }

        .voting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .voting-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .vote-count {
            color: #666;
            font-size: 14px;
        }

        .vote-progress {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s;
        }

        .vote-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .vote-question {
            margin-bottom: 20px;
            font-size: 16px;
            color: #444;
        }

        .vote-progress {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill.support {
            height: 100%;
            background: #28a745;
            transition: width 0.3s;
        }

        .progress-fill.oppose {
            height: 100%;
            background: #dc3545;
            transition: width 0.3s;
        }

        .progress-bar-dual {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
            display: flex;
        }

        .vote-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .support-stat {
            color: #28a745;
            font-weight: 500;
        }

        .oppose-stat {
            color: #dc3545;
            font-weight: 500;
        }

        .vote-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .vote-btn {
            flex: 1;
            max-width: 200px;
            padding: 15px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .vote-btn:hover {
            border-color: #999;
        }

        .vote-btn.support {
            border-color: #28a745;
            color: #28a745;
        }

        .vote-btn.support:hover,
        .vote-btn.support.voted {
            background: #28a745;
            color: white;
        }

        .vote-btn.oppose {
            border-color: #dc3545;
            color: #dc3545;
        }

        .vote-btn.oppose:hover,
        .vote-btn.oppose.voted {
            background: #dc3545;
            color: white;
        }

        .vote-text {
            font-weight: 600;
            font-size: 16px;
        }

        .vote-desc {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .status-badge.confirmed {
            background: #ddd6fe;
            color: #5b21b6;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .vote-final-message {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
            color: #666;
        }

        .vote-final {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .vote-result {
            text-align: center;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
            margin-top: 15px;
        }

        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* AIåˆ†æåŒºåŸŸ - ä¿æŒåŸæœ‰ç®€æ´é£æ ¼ */
        .ai-analysis-section {
            background: #f8f9fa;
            padding: 25px 30px;
            border-top: 1px solid #eee;
        }

        .ai-analysis-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .ai-rating-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .rating-reliable { background: #d4edda; color: #155724; }
        .rating-questionable { background: #fff3cd; color: #856404; }
        .rating-unreliable { background: #f8d7da; color: #721c24; }
        .rating-insufficient { background: #e2e3e5; color: #383d41; }

        .ai-summary-content {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #2c5aa0;
            font-size: 16px;
            line-height: 1.6;
            color: #444;
        }

        /* ä¿¡æ¯æºåŒºåŸŸ - ä¿æŒåŸæœ‰ç®€æ´é£æ ¼ */
        .sources-section {
            background: #f8f9fa;
            padding: 25px 30px;
            border-top: 1px solid #eee;
        }

        .sources-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .source-list {
            display: grid;
            gap: 15px;
        }

        .source-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .source-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .source-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .source-url {
            color: #2c5aa0;
            text-decoration: none;
            font-size: 14px;
            word-break: break-all;
            display: block;
            margin-bottom: 10px;
        }

        .source-url:hover {
            text-decoration: underline;
        }

        .source-summary {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            font-style: italic;
        }

        /* æ“ä½œæŒ‰é’® */
        .actions {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.9);
            color: #64748b;
            text-decoration: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: transparent;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
        }

        .btn-success:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);        }

        .login-prompt {
            text-align: center;
            padding: 20px;
            color: #666;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .login-prompt a {
            color: #2c5aa0;
            text-decoration: none;
        }

        .login-prompt a:hover {
            text-decoration: underline;
        }

        /* AIå¤„ç†çŠ¶æ€æ ·å¼ */
        .ai-processing-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            color: #856404;
            font-weight: 500;
        }

        .loading-icon {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .event-title {
                font-size: 24px;
            }

            .event-meta {
                flex-direction: column;
                gap: 10px;
            }

            .event-header,
            .event-content,
            .voting-section,
            .analysis-section,
            .sources-section {
                padding: 20px 15px;
            }

            .vote-buttons {
                flex-direction: column;
            }

            .vote-btn {
                max-width: none;
            }

            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>


    <main>
        <div class="container">
            <div class="main-content">
                <div class="event-detail" id="event-detail">
                    <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>            </div>
        </div>
    </main>

    <!-- å¼•å…¥å¯¼èˆªæ ç»„ä»¶ -->
    <script src="./js/nav.js"></script>
    <!-- å¼•å…¥APIç®¡ç†å™¨ -->
    <script src="./js/api.js"></script>
    <script>
        let eventData = null;
        let currentUser = null;
        let userVote = null;

        // ===== åˆ·æ–°åæ¢å¤åˆ†æè¿›åº¦ï¼šæœ¬åœ°æŒä¹…åŒ– =====
        const ANALYSIS_SESSIONS_KEY = 'tm_ai_analysis_sessions';

        // ç»Ÿä¸€æç¤ºæ°”æ³¡
        function showToast(message, type = 'info') {
            const colors = {
                info: '#3b82f6',
                success: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            };
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; right: 20px; top: 20px; z-index: 9999;
                background: ${colors[type]}; color: white; padding: 10px 14px;
                border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
                font-size: 14px;`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function readAnalysisSessions() {
            try {
                const raw = localStorage.getItem(ANALYSIS_SESSIONS_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (e) {
                return {};
            }
        }

        function writeAnalysisSessions(sessions) {
            try {
                localStorage.setItem(ANALYSIS_SESSIONS_KEY, JSON.stringify(sessions));
            } catch (e) {
                // å¿½ç•¥å­˜å‚¨é”™è¯¯
            }
        }

        function saveAnalysisSession(eventId) {
            const sessions = readAnalysisSessions();
            sessions[eventId] = {
                eventId: Number(eventId),
                startedAt: Date.now()
            };
            writeAnalysisSessions(sessions);
        }

        function clearAnalysisSession(eventId) {
            const sessions = readAnalysisSessions();
            if (sessions[eventId]) {
                delete sessions[eventId];
                writeAnalysisSessions(sessions);
            }
        }

        // æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰
        function garbageCollectSessions(maxAgeMs = 30 * 60 * 1000) {
            const now = Date.now();
            const sessions = readAnalysisSessions();
            let changed = false;
            Object.keys(sessions).forEach(id => {
                if (!sessions[id]?.startedAt || (now - sessions[id].startedAt) > maxAgeMs) {
                    delete sessions[id];
                    changed = true;
                }
            });
            if (changed) writeAnalysisSessions(sessions);
        }

        async function resumeAnalysisIfOngoing(eventId) {
            const sessions = readAnalysisSessions();
            const sess = sessions[eventId];
            if (!sess) return;

            // å‘åç«¯æ ¸å¯¹çœŸå®çŠ¶æ€ï¼Œè‹¥ä¸æ˜¯ started åˆ™æ¸…ç†
            try {
                const status = await api.getAnalysisStatus(eventId);
                if (!status || (status.status !== 'started' && status.status !== 'completed')) {
                    clearAnalysisSession(eventId);
                    const existing = document.getElementById(`progress-${eventId}`);
                    if (existing) existing.remove();
                    return;
                }
            } catch (_) {}

            const stepDuration = 15000; // ä¸è¿›åº¦ç›‘æ§ä¿æŒä¸€è‡´
            const totalSteps = 7;
            const elapsed = Math.max(0, Date.now() - (sess.startedAt || Date.now()));
            let currentStep = Math.min(totalSteps, Math.floor(elapsed / stepDuration) + 1);

            // æ„é€ ä¸å¯åŠ¨æ¥å£ä¸€è‡´çš„æœ€å°ç»“æœå¯¹è±¡ç”¨äºæ¸²æŸ“è¿›åº¦æ¡†
            const fakeResult = { success: true, event_id: Number(eventId) };
            showRealTimeAnalysisProgress(fakeResult);

            // å…ˆæŠŠå·²å®Œæˆæ­¥éª¤æ¸²æŸ“å‡ºæ¥
            for (let s = 1; s < currentStep; s++) {
                updateProgressStep(eventId, s);
            }
            updateProgressStep(eventId, currentStep);

            // æ¢å¤å®šæ—¶å™¨ï¼Œä»å½“å‰æ­¥éª¤ç»§ç»­
            startAnalysisProgressMonitor(eventId, currentStep);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const analysisBtn = document.getElementById('analysis-btn');
            if (analysisBtn) {
                analysisBtn.disabled = true;
                analysisBtn.innerHTML = 'ğŸš€ åå°åˆ†æä¸­...';
                analysisBtn.style.background = 'linear-gradient(45deg, #f59e0b, #d97706)';
            }

            showToast('å·²ä¸ºä½ æ¢å¤AIåˆ†æè¿›åº¦', 'success');
        }

        // äº‹ä»¶çŠ¶æ€æ ‡ç­¾æ˜ å°„ï¼ˆä¸index.htmlä¿æŒä¸€è‡´ï¼‰
        window.STATUS_LABELS = window.STATUS_LABELS || {
            'pending': 'å¾…å®¡æ ¸',
            'nominated': 'å·²æå',
            'processing': 'å¤„ç†ä¸­',
            'voting': 'æŠ•ç¥¨ä¸­',
            'confirmed': 'å·²ç¡®è®¤'
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            const userStr = localStorage.getItem('currentUser');
            if (userStr) {
                try {
                    currentUser = JSON.parse(userStr);
                } catch (error) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                }
            }

            // è·å–äº‹ä»¶ID
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            
            if (eventId) {
                garbageCollectSessions();
                loadEvent(eventId);
                // å°è¯•æ¢å¤æœ€ç»ˆç»“æœ
                const cached = localStorage.getItem(`tm_ai_result_${eventId}`);
                if (cached) {
                    try {
                        const parsed = JSON.parse(cached);
                        showAnalysisResult(parsed);
                    } catch (e) {}
                }
                // è‹¥æœ‰ä¼šè¯ï¼Œæ ¡éªŒå¹¶æ¢å¤
                resumeAnalysisIfOngoing(eventId);
            } else {
                showError('æœªæŒ‡å®šäº‹ä»¶ID');
            }
        });

        // åŠ è½½äº‹ä»¶è¯¦æƒ…ï¼ˆä½¿ç”¨çœŸå®APIï¼‰
        async function loadEvent(eventId) {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showLoading();
                
                // ä½¿ç”¨ç®€åŒ–çš„APIè°ƒç”¨ï¼Œç›´æ¥è·å–äº‹ä»¶è¯¦æƒ…
                eventData = await api.getEventDetail(eventId);
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ£€æŸ¥æŠ•ç¥¨çŠ¶æ€ï¼ˆæŠ•ç¥¨é˜¶æ®µå’Œå·²ç¡®è®¤é˜¶æ®µéƒ½éœ€è¦ï¼‰
                if (currentUser && (eventData.status === 'voting' || eventData.status === 'confirmed')) {
                    try {
                        const votes = await api.getEventVotes(eventId);
                        userVote = votes.find(vote => vote.user_id === currentUser.id);
                        console.log('ç”¨æˆ·æŠ•ç¥¨çŠ¶æ€:', userVote);
                    } catch (error) {
                        console.log('è·å–ç”¨æˆ·æŠ•ç¥¨çŠ¶æ€å¤±è´¥:', error);
                    }
                }
                
                renderEvent();
                // æ¸²æŸ“åå°è¯•æ¢å¤åˆ†æè¿›åº¦
                resumeAnalysisIfOngoing(eventId);
                
            } catch (error) {
                console.error('åŠ è½½äº‹ä»¶å¤±è´¥:', error);
                showError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const container = document.getElementById('event-detail');

            container.innerHTML = `
                <div class="event-header">
                    <div class="event-title">åŠ è½½ä¸­...</div>
                </div>
                <div class="event-content">
                    <p>æ­£åœ¨è·å–äº‹ä»¶è¯¦æƒ…ï¼Œè¯·ç¨å€™</p>
                </div>
            `;
        }

        // è·å–ç¤ºä¾‹äº‹ä»¶æ•°æ®ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä½†é€‚é…APIæ ¼å¼ï¼‰
        function getMockEventData(eventId) {
            const mockEvents = {
                '1': {
                    id: 1,
                    title: 'æŸåœ°å‘ç”Ÿé‡å¤§äº¤é€šäº‹æ•…',
                    description: `æ®æŠ¥é“ï¼Œä»Šæ—¥ä¸Šåˆ10æ—¶è®¸ï¼ŒæŸçœæŸå¸‚é«˜é€Ÿå…¬è·¯å‘ç”Ÿå¤šè½¦è¿ç¯ç›¸æ’äº‹æ•…ã€‚ç°åœºåˆæ­¥ç»Ÿè®¡æœ‰15è¾†è½¦ä¸åŒç¨‹åº¦å—æŸï¼Œé€ æˆ3äººæ­»äº¡ï¼Œ8äººå—ä¼¤ã€‚

äº‹æ•…å‘ç”Ÿåï¼Œå½“åœ°äº¤è­¦ã€æ¶ˆé˜²ã€åŒ»ç–—ç­‰éƒ¨é—¨è¿…é€Ÿèµ¶åˆ°ç°åœºè¿›è¡Œæ•‘æ´å¤„ç†ã€‚ç›®å‰ä¼¤è€…å·²é€å¾€é™„è¿‘åŒ»é™¢æ¥å—æ²»ç–—ï¼Œäº‹æ•…åŸå› æ­£åœ¨è°ƒæŸ¥ä¸­ã€‚

æ®ç°åœºç›®å‡»è€…æè¿°ï¼Œäº‹å‘æ—¶è·¯é¢å­˜åœ¨å¤§é›¾å¤©æ°”ï¼Œèƒ½è§åº¦è¾ƒä½ã€‚é«˜é€Ÿäº¤è­¦æé†’å¹¿å¤§é©¾é©¶å‘˜ï¼Œé›¾å¤©è¡Œè½¦åŠ¡å¿…å‡é€Ÿæ…¢è¡Œï¼Œä¿æŒå®‰å…¨è·ç¦»ã€‚

ç›¸å…³éƒ¨é—¨è¡¨ç¤ºï¼Œå°†å…¨åŠ›åšå¥½äº‹æ•…å–„åå¤„ç†å·¥ä½œï¼Œå¹¶åŠ å¼ºé«˜é€Ÿå…¬è·¯å®‰å…¨ç®¡æ§ï¼Œé˜²èŒƒç±»ä¼¼äº‹æ•…å†æ¬¡å‘ç”Ÿã€‚`,
                    keywords: 'äº¤é€šäº‹æ•…,é«˜é€Ÿå…¬è·¯,å¤§é›¾,ä¼¤äº¡',
                    status: 'voting',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    interest_count: 156,
                    creator_id: 1,
                    creator: {
                        id: 1,
                        username: 'news_reporter',
                        email: 'reporter@example.com',
                        role: 'user'
                    },
                    vote_stats: {
                        total_votes: 1123,
                        support_votes: 892,
                        oppose_votes: 231,
                        support_percentage: 79.4,
                        oppose_percentage: 20.6
                    },
                    ai_analysis: {
                        id: 1,
                        support_arguments: 'å¤šä¸ªå®˜æ–¹åª’ä½“æŠ¥é“ä¸€è‡´ï¼›ç°åœºç…§ç‰‡å’Œè§†é¢‘è¯æ®å……åˆ†ï¼›ç›¸å…³éƒ¨é—¨åŠæ—¶å“åº”å¤„ç†',
                        oppose_arguments: 'éƒ¨åˆ†ç»†èŠ‚æè¿°å­˜åœ¨å·®å¼‚ï¼›æœªè§å®˜æ–¹æƒå¨ç¡®è®¤ä¼¤äº¡æ•°å­—',
                        ai_judgment: 'support',
                        confidence_score: 0.75,
                        created_at: new Date().toISOString()
                    },
                    information_sources: [
                        {
                            id: 1,
                            url: 'http://example.com/traffic-report',
                            title: 'å½“åœ°äº¤è­¦éƒ¨é—¨å®˜æ–¹é€šæŠ¥',
                            content: 'å®˜æ–¹ç¡®è®¤äº‹æ•…åŸºæœ¬ä¿¡æ¯',
                            stance: 'support',
                            relevance_score: 0.9,
                            ai_summary: 'å®˜æ–¹æƒå¨ä¿¡æ¯æºï¼Œç¡®è®¤äº‹æ•…å‘ç”Ÿå’ŒåŸºæœ¬æƒ…å†µ',
                            created_at: new Date().toISOString()
                        },
                        {
                            id: 2,
                            url: 'http://example.com/news-report',
                            title: 'æ–°é—»åª’ä½“ç°åœºæŠ¥é“',
                            content: 'è®°è€…ç°åœºé‡‡è®¿å’Œå›¾ç‰‡æŠ¥é“',
                            stance: 'support',
                            relevance_score: 0.75,
                            ai_summary: 'ç°åœºæŠ¥é“æä¾›è¯¦ç»†æƒ…å†µå’Œå›¾ç‰‡è¯æ®',
                            created_at: new Date().toISOString()
                        }
                    ]
                },
                '2': {
                    id: 2,
                    title: 'æ–°å‹ç§‘æŠ€äº§å“å‘å¸ƒä¼š',
                    description: 'æŸçŸ¥åç§‘æŠ€å…¬å¸å®£å¸ƒå°†äºä¸‹æœˆä¸¾åŠæ–°äº§å“å‘å¸ƒä¼šï¼Œé¢„è®¡å°†æ¨å‡ºé©å‘½æ€§çš„æ–°æŠ€æœ¯äº§å“ã€‚æ®å†…éƒ¨æ¶ˆæ¯é€éœ²ï¼Œè¯¥äº§å“å¯èƒ½æ¶‰åŠäººå·¥æ™ºèƒ½å’Œé‡å­è®¡ç®—æŠ€æœ¯çš„çªç ´ã€‚',
                    keywords: 'ç§‘æŠ€,å‘å¸ƒä¼š,æ–°äº§å“,äººå·¥æ™ºèƒ½',
                    status: 'processing',
                    created_at: new Date(Date.now() - 86400000).toISOString(),
                    updated_at: new Date(Date.now() - 86400000).toISOString(),
                    interest_count: 234,
                    creator_id: 2,
                    creator: {
                        id: 2,
                        username: 'tech_watcher',
                        email: 'tech@example.com',
                        role: 'user'
                    },
                    information_sources: []
                }
            };
            
            return mockEvents[eventId] || {
                id: parseInt(eventId) || 0,
                title: 'äº‹ä»¶ä¸å­˜åœ¨',
                description: 'æŠ±æ­‰ï¼Œæœªæ‰¾åˆ°æŒ‡å®šçš„äº‹ä»¶ä¿¡æ¯ã€‚',
                keywords: '',
                status: 'pending',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                interest_count: 0,
                creator_id: 1,
                creator: {
                    id: 1,
                    username: 'system',
                    email: 'system@example.com',
                    role: 'user'
                },
                information_sources: []
            };
        }

        // æ¸²æŸ“äº‹ä»¶è¯¦æƒ…
        function renderEvent() {
            const container = document.getElementById('event-detail');
            const minInterest = Number(localStorage.getItem('tm_interest_threshold') || 10);
            const canAnalyseByInterest = Number(eventData.interest_count || 0) >= minInterest;
            const isAdminUser = !!(currentUser && currentUser.role === 'admin');
            const adminApproved = (eventData.status && eventData.status !== 'pending') || isAdminUser;
            const hideGeneralAnalysisForAdmin = isAdminUser && eventData.status === 'nominated';
            
            container.innerHTML = `
                <div class="event-header">
                    <div class="event-status status-${eventData.status}">
                        ${window.STATUS_LABELS[eventData.status] || eventData.status}
                    </div>
                    <h1 class="event-title">${eventData.title || 'æœªçŸ¥äº‹ä»¶'}</h1>
                    <div class="event-meta">
                        <span>å‘å¸ƒæ—¶é—´ï¼š${formatDate(eventData.created_at)}</span>
                        <span>å‘å¸ƒè€…ï¼š${eventData.creator?.username || eventData.creator?.nickname || 'æœªçŸ¥'}</span>
                        <span>å…³æ³¨äººæ•°ï¼š${eventData.interest_count || 0} äºº</span>
                        ${eventData.vote_stats ? `<span>æŠ•ç¥¨æ•°ï¼š${eventData.vote_stats.total_votes || 0} ç¥¨</span>` : ''}
                    </div>
                </div>

                <div class="event-content">
                    <div class="event-description">
                        ${formatDescription(eventData.description)}
                    </div>
                    ${eventData.keywords ? `
                        <div class="event-keywords">
                            <strong>å…³é”®è¯ï¼š</strong>${eventData.keywords}
                        </div>
                    ` : ''}
                </div>

                ${renderSourcesSection()}
                ${renderAnalysisSection()}
                ${renderVotingSection()}

                <div class="actions">
                    <button class="btn" onclick="toggleInterest()" ${!currentUser ? 'disabled title="è¯·å…ˆç™»å½•"' : ''}>
                        ${eventData.user_interested ? 'å–æ¶ˆå…³æ³¨' : 'å…³æ³¨æ­¤äº‹ä»¶'}
                    </button>
                    ${hideGeneralAnalysisForAdmin ? '' : `
                    <button class="btn btn-success" onclick="triggerNewsAnalysis()" id="analysis-btn" ${(canAnalyseByInterest || adminApproved) ? '' : `disabled title="å…³æ³¨äººæ•°éœ€â‰¥${minInterest}æˆ–ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡"`}>
                        ğŸ¤– æ™ºèƒ½åˆ†æ
                    </button>`}
                    <button class="btn btn-primary" onclick="shareEvent()">åˆ†äº«</button>
                    ${renderAdminActions()}
                    <a href="./index.html" class="btn">è¿”å›åˆ—è¡¨</a>
                </div>
            `;

            // å¯åŠ¨é˜ˆå€¼ç›‘æ§
            startInterestWatcher(eventData.id, minInterest);

            // è‹¥åˆ†ææŒ‰é’®è¢«ç¦ç”¨ï¼Œæ˜¾ç¤ºæ¡ä»¶æç¤ºå¹¶æ‹¦æˆªç‚¹å‡»
            const analysisBtn = document.getElementById('analysis-btn');
            if (analysisBtn && analysisBtn.disabled) {
                showAnalysisDisabledHint(minInterest);
            }
        }

        // æ¸²æŸ“ç®¡ç†å‘˜æ“ä½œæŒ‰é’®
        function renderAdminActions() {
            // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½çœ‹åˆ°ç®¡ç†æ“ä½œ
            if (!currentUser || currentUser.role !== 'admin') {
                return '';
            }

            let actions = '';

            // æ ¹æ®å½“å‰çŠ¶æ€æ˜¾ç¤ºç›¸åº”çš„æ“ä½œæŒ‰é’®
            switch (eventData.status) {
                case 'pending':
                    actions = '<button class="btn btn-primary" onclick="approveEvent()">å®¡æ ¸é€šè¿‡</button>';
                    break;
                case 'nominated':
                    actions = '<button class="btn btn-warning" onclick="startAIProcessing()">å¼€å§‹AIåˆ†æ</button>';
                    break;
                case 'processing':
                    actions = '<div class="ai-processing-status"><i class="loading-icon">â³</i> AIåˆ†æä¸­ï¼Œè¯·ç¨å€™...</div>';
                    break;
                case 'voting':
                    actions = '<button class="btn btn-info" onclick="viewVoteDetails()">æŸ¥çœ‹æŠ•ç¥¨è¯¦æƒ…</button>';
                    break;
            }

            return actions;
        }

        // å…³æ³¨äººæ•°é˜ˆå€¼ç›‘æ§ï¼šæ¯10ç§’æ‹‰å–è¯¦æƒ…ï¼Œè¾¾æ ‡æ—¶æç¤ºå¹¶è§£é”æŒ‰é’®
        let interestWatcher = null;
        function startInterestWatcher(eventId, minInterest) {
            if (interestWatcher) clearInterval(interestWatcher);
            interestWatcher = setInterval(async () => {
                try {
                    const detail = await api.getEventDetail(eventId);
                    const count = Number(detail?.interest_count || 0);
                    const statusVal = detail?.status;
                    const analysisBtn = document.getElementById('analysis-btn');
                    const canAnalyse = count >= minInterest || (statusVal && statusVal !== 'pending');
                    if (canAnalyse && analysisBtn && analysisBtn.disabled) {
                        analysisBtn.disabled = false;
                        analysisBtn.removeAttribute('title');
                        showToast(`å…³æ³¨äººæ•°å·²è¾¾åˆ°${minInterest}æˆ–å·²å®¡æ ¸é€šè¿‡ï¼Œç°å¯å¯åŠ¨AIåˆ†æ`, 'success');
                        clearInterval(interestWatcher);
                    }
                } catch (_) {}
            }, 10000);
        }

        // å½“æœªè¾¾æˆæ¡ä»¶æ—¶ï¼Œä»…åœ¨æŒ‰é’®ä¸Šæç¤ºå¹¶æ‹¦æˆªç‚¹å‡»
        function showAnalysisDisabledHint(minInterest) {
            const btn = document.getElementById('analysis-btn');
            if (!btn) return;
            // ä»…ç»™æŒ‰é’®æ·»åŠ  titleï¼Œä¸å†æ’å…¥ä¸‹æ–¹è¯´æ˜å¡ç‰‡
            btn.title = `å…³æ³¨äººæ•°éœ€â‰¥${minInterest}æˆ–ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡`;

            // ä¸ºç¦ç”¨æŒ‰é’®æ·»åŠ é€æ˜è¦†ç›–å±‚ï¼Œç¡®ä¿ç‚¹å‡»ä¹Ÿèƒ½æç¤º
            try {
                btn.style.position = 'relative';
                const layerId = 'analysis-disabled-overlay';
                if (!document.getElementById(layerId)) {
                    const overlay = document.createElement('div');
                    overlay.id = layerId;
                    overlay.style.cssText = 'position:absolute;inset:0;cursor:not-allowed;background:transparent;';
                    overlay.addEventListener('click', function(e){
                        e.preventDefault();
                        e.stopPropagation();
                        showToast(`éœ€å…³æ³¨äººæ•°â‰¥${minInterest}æˆ–ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡åæ‰èƒ½å¯åŠ¨AIåˆ†æ`, 'warning');
                    });
                    btn.appendChild(overlay);
                }
            } catch (_) {}
        }

        // æ¸²æŸ“æŠ•ç¥¨åŒºåŸŸ
        function renderVotingSection() {
            // åœ¨æŠ•ç¥¨é˜¶æ®µå’Œå·²ç¡®è®¤é˜¶æ®µæ˜¾ç¤ºæŠ•ç¥¨åŒºåŸŸ
            if (eventData.status !== 'voting' && eventData.status !== 'confirmed') {
                return '';
            }

            if (!currentUser) {
                return `
                    <div class="voting-section">
                        <div class="login-prompt">
                            <p>è¯·å…ˆ <a href="./auth.html">ç™»å½•</a> åå‚ä¸æŠ•ç¥¨</p>
                        </div>
                    </div>
                `;
            }

            // æŠ•ç¥¨ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨ç°æœ‰å­—æ®µæˆ–é»˜è®¤å€¼ï¼‰
            const totalVotes = eventData.vote_count || 0;
            const supportVotes = eventData.support_votes || 0;
            const opposeVotes = eventData.oppose_votes || 0;
            const supportPercentage = totalVotes > 0 ? (supportVotes / totalVotes * 100) : 0;
            const opposePercentage = totalVotes > 0 ? (opposeVotes / totalVotes * 100) : 0;

            // å¦‚æœç”¨æˆ·å·²æŠ•ç¥¨æˆ–äº‹ä»¶å·²ç¡®è®¤ï¼Œæ˜¾ç¤ºæŠ•ç¥¨ç»“æœ
            if (userVote || eventData.status === 'confirmed') {
                return `
                    <div class="voting-section">
                        <div class="voting-header">
                            <h3 class="voting-title">${eventData.status === 'confirmed' ? 'AIåˆ†æç»“æœè¯„ä»·' : 'æ‚¨è®¤ä¸ºAIåˆ†æç»“æœå¦‚ä½•ï¼Ÿ'}</h3>
                            <span class="vote-count">å…± ${totalVotes} äººæŠ•ç¥¨</span>
                            ${eventData.status === 'confirmed' ? '<span class="status-badge confirmed">æŠ•ç¥¨å·²ç»“æŸ</span>' : ''}
                        </div>

                        <div class="vote-progress">
                            <div class="progress-bar-dual">
                                <div class="progress-fill support" style="width: ${supportPercentage}%"></div>
                                <div class="progress-fill oppose" style="width: ${opposePercentage}%"></div>
                            </div>
                            <div class="vote-stats">
                                <span class="support-stat">è®¤åŒ ${supportPercentage.toFixed(1)}% (${supportVotes}ç¥¨)</span>
                                <span class="oppose-stat">ä¸è®¤åŒ ${opposePercentage.toFixed(1)}% (${opposeVotes}ç¥¨)</span>
                            </div>
                        </div>

                        ${userVote && eventData.status === 'voting' ? `
                            <div class="vote-result">
                                <p>æ‚¨çš„æŠ•ç¥¨ï¼š<strong>${userVote.stance === 'support' ? 'è®¤åŒ' : 'ä¸è®¤åŒ'}</strong></p>
                                <button class="btn btn-secondary" onclick="changeVote()">ä¿®æ”¹æŠ•ç¥¨</button>
                            </div>
                        ` : userVote && eventData.status === 'confirmed' ? `
                            <div class="vote-result">
                                <p>æ‚¨çš„æŠ•ç¥¨ï¼š<strong>${userVote.stance === 'support' ? 'è®¤åŒ' : 'ä¸è®¤åŒ'}</strong></p>
                                <p class="vote-final">æŠ•ç¥¨å·²ç»“æŸï¼Œæ— æ³•ä¿®æ”¹</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // å¦‚æœäº‹ä»¶å·²ç¡®è®¤ï¼Œåªæ˜¾ç¤ºç»“æœä¸æ˜¾ç¤ºæŠ•ç¥¨æŒ‰é’®
            if (eventData.status === 'confirmed') {
                return `
                    <div class="voting-section">
                        <div class="voting-header">
                            <h3 class="voting-title">AIåˆ†æç»“æœè¯„ä»·</h3>
                            <span class="vote-count">å…± ${totalVotes} äººæŠ•ç¥¨</span>
                            <span class="status-badge confirmed">æŠ•ç¥¨å·²ç»“æŸ</span>
                        </div>

                        <div class="vote-progress">
                            <div class="progress-bar-dual">
                                <div class="progress-fill support" style="width: ${supportPercentage}%"></div>
                                <div class="progress-fill oppose" style="width: ${opposePercentage}%"></div>
                            </div>
                            <div class="vote-stats">
                                <span class="support-stat">è®¤åŒ ${supportPercentage.toFixed(1)}% (${supportVotes}ç¥¨)</span>
                                <span class="oppose-stat">ä¸è®¤åŒ ${opposePercentage.toFixed(1)}% (${opposeVotes}ç¥¨)</span>
                            </div>
                        </div>

                        <div class="vote-final-message">
                            <p>æŠ•ç¥¨å·²è¾¾åˆ°20ç¥¨é˜ˆå€¼ï¼ŒæŠ•ç¥¨é˜¶æ®µç»“æŸã€‚</p>
                        </div>
                    </div>
                `;
            }

            // æŠ•ç¥¨é˜¶æ®µï¼Œæ˜¾ç¤ºæŠ•ç¥¨æŒ‰é’®
            return `
                <div class="voting-section">
                    <div class="voting-header">
                        <h3 class="voting-title">æ‚¨è®¤ä¸ºAIåˆ†æç»“æœå¦‚ä½•ï¼Ÿ</h3>
                        <span class="vote-count">å…± ${totalVotes} äººæŠ•ç¥¨</span>
                    </div>

                    <div class="vote-question">
                        <p>è¯·åŸºäºä¸Šè¿°AIåˆ†æå’Œä¿¡æ¯æºï¼Œå¯¹AIçš„åˆ†æç»“æœè¿›è¡Œè¯„ä»·ï¼š</p>
                    </div>

                    ${totalVotes > 0 ? `
                        <div class="vote-progress">
                            <div class="progress-bar-dual">
                                <div class="progress-fill support" style="width: ${supportPercentage}%"></div>
                                <div class="progress-fill oppose" style="width: ${opposePercentage}%"></div>
                            </div>
                            <div class="vote-stats">
                                <span class="support-stat">è®¤åŒ ${supportPercentage.toFixed(1)}% (${supportVotes}ç¥¨)</span>
                                <span class="oppose-stat">ä¸è®¤åŒ ${opposePercentage.toFixed(1)}% (${opposeVotes}ç¥¨)</span>
                            </div>
                        </div>
                    ` : ''}

                    <div class="vote-buttons">
                        <button class="vote-btn support" onclick="vote('support')">
                            <span class="vote-text">è®¤åŒAIåˆ†æ</span>
                            <span class="vote-desc">åˆ†æåˆç†ï¼Œç»“è®ºå¯ä¿¡</span>
                        </button>
                        <button class="vote-btn oppose" onclick="vote('oppose')">
                            <span class="vote-text">ä¸è®¤åŒAIåˆ†æ</span>
                            <span class="vote-desc">åˆ†ææœ‰è¯¯ï¼Œç»“è®ºå­˜ç–‘</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“AIåˆ†æåŒºåŸŸ
        function renderAnalysisSection() {
            // åœ¨æŠ•ç¥¨é˜¶æ®µå’Œå·²ç¡®è®¤é˜¶æ®µæ˜¾ç¤ºAIåˆ†æç»“æœ
            if ((eventData.status !== 'voting' && eventData.status !== 'confirmed') || !eventData.ai_summary) {
                return '';
            }

            // AIè¯„çº§çš„æ˜¾ç¤ºæ˜ å°„
            const ratingClasses = {
                'reliable': 'rating-reliable',
                'questionable': 'rating-questionable',
                'unreliable': 'rating-unreliable',
                'insufficient': 'rating-insufficient'
            };

            const ratingTexts = {
                'reliable': 'å¯ä¿¡',
                'questionable': 'å­˜ç–‘',
                'unreliable': 'ä¸å¯ä¿¡',
                'insufficient': 'ä¿¡æ¯ä¸è¶³'
            };

            const ratingClass = ratingClasses[eventData.ai_rating] || 'rating-insufficient';
            const ratingText = ratingTexts[eventData.ai_rating] || 'ä¿¡æ¯ä¸è¶³';

            return `
                <div class="ai-analysis-section">
                    <h3 class="ai-analysis-title">AIæ™ºèƒ½åˆ†æ</h3>
                    <div class="ai-rating-badge ${ratingClass}">
                        AIè¯„çº§ï¼š${ratingText}
                    </div>
                    <div class="ai-summary-content">
                        ${eventData.ai_summary}
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“ä¿¡æ¯æºåŒºåŸŸ
        function renderSourcesSection() {
            // åœ¨æŠ•ç¥¨é˜¶æ®µå’Œå·²ç¡®è®¤é˜¶æ®µæ˜¾ç¤ºä¿¡æ¯æº
            if ((eventData.status !== 'voting' && eventData.status !== 'confirmed') || !eventData.information_sources || eventData.information_sources.length === 0) {
                return '';
            }

            return `
                <div class="sources-section">
                    <h3 class="sources-title">ä¿¡æ¯æ¥æº</h3>
                    <div class="source-list">
                        ${eventData.information_sources.map((source, index) => `
                            <div class="source-item">
                                <div class="source-title">${source.title || 'ä¿¡æ¯æº ' + (index + 1)}</div>
                                <div class="source-meta">
                                    <span>${source.website_name || 'æœªçŸ¥æ¥æº'}</span>
                                    <span>ç›¸å…³åº¦: ${Math.round((source.relevance_score || 0) * 100)}%</span>
                                </div>
                                <a href="${source.url}" target="_blank" class="source-url">${source.url}</a>
                                ${source.ai_summary ? `<div class="source-summary">AIæ‘˜è¦ï¼š${source.ai_summary}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // æ ¼å¼åŒ–æè¿°æ–‡æœ¬
        function formatDescription(description) {
            return description.split('\n').map(paragraph => 
                paragraph.trim() ? `<p>${paragraph.trim()}</p>` : ''
            ).join('');
        }

        // æŠ•ç¥¨åŠŸèƒ½ï¼ˆä½¿ç”¨çœŸå®APIï¼‰
        async function vote(stance) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = './auth.html';
                return;
            }

            try {
                // ç¦ç”¨æŠ•ç¥¨æŒ‰é’®
                const voteButtons = document.querySelectorAll('.vote-btn');
                voteButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = 'æŠ•ç¥¨ä¸­...';
                });

                // è°ƒç”¨æŠ•ç¥¨API
                const voteResult = await api.apiCall('/votes/', {
                    method: 'POST',
                    headers: {
                        'x-user-id': currentUser.id.toString()
                    },
                    body: JSON.stringify({
                        event_id: eventData.id,
                        stance: stance
                    })
                });

                if (voteResult) {
                    // è®°å½•ç”¨æˆ·æŠ•ç¥¨ - åˆ›å»ºæ­£ç¡®çš„ç”¨æˆ·æŠ•ç¥¨å¯¹è±¡
                    userVote = {
                        id: voteResult.vote_id,
                        stance: stance,
                        user_id: currentUser.id,
                        event_id: eventData.id
                    };

                    // é‡æ–°åŠ è½½äº‹ä»¶æ•°æ®ä»¥è·å–æœ€æ–°çš„æŠ•ç¥¨ç»Ÿè®¡
                    const updatedEvent = await api.getEventDetail(eventData.id);
                    eventData.vote_count = updatedEvent.vote_count;
                    eventData.support_votes = updatedEvent.support_votes;
                    eventData.oppose_votes = updatedEvent.oppose_votes;

                    // é‡æ–°æ¸²æŸ“é¡µé¢
                    renderEvent();

                    alert(`æŠ•ç¥¨æˆåŠŸï¼æ‚¨é€‰æ‹©äº†"${stance === 'support' ? 'è®¤åŒ' : 'ä¸è®¤åŒ'}"`);
                }
                
            } catch (error) {
                console.error('æŠ•ç¥¨å¤±è´¥:', error);
                
                if (error.message.includes('å·²ç»å¯¹æ­¤äº‹ä»¶æŠ•è¿‡ç¥¨')) {
                    alert('æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œæ¯äººæ¯äº‹ä»¶åªèƒ½æŠ•ç¥¨ä¸€æ¬¡');
                } else {
                    alert('æŠ•ç¥¨å¤±è´¥: ' + error.message);
                }
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    renderEvent();
                }, 1000);
            }
        }

        // ä¿®æ”¹æŠ•ç¥¨
        async function changeVote() {
            if (!userVote) return;

            if (confirm('ç¡®å®šè¦ä¿®æ”¹æŠ•ç¥¨å—ï¼Ÿ')) {
                try {
                    // è·å–å½“å‰ç”¨æˆ·ID
                    const currentUserId = currentUser ? currentUser.id : 1;

                    // è°ƒç”¨åˆ é™¤æŠ•ç¥¨APIï¼Œä¼ é€’ç”¨æˆ·ID
                    await api.apiCall(`/votes/${userVote.id}?current_user_id=${currentUserId}`, {
                        method: 'DELETE'
                    });

                    userVote = null;

                    // é‡æ–°åŠ è½½äº‹ä»¶æ•°æ®ä»¥è·å–æœ€æ–°çš„æŠ•ç¥¨ç»Ÿè®¡
                    const updatedEvent = await api.getEventDetail(eventData.id);
                    eventData.vote_count = updatedEvent.vote_count;
                    eventData.support_votes = updatedEvent.support_votes;
                    eventData.oppose_votes = updatedEvent.oppose_votes;

                    renderEvent();
                    alert('æŠ•ç¥¨å·²å–æ¶ˆï¼Œæ‚¨å¯ä»¥é‡æ–°æŠ•ç¥¨');
                } catch (error) {
                    console.error('ä¿®æ”¹æŠ•ç¥¨å¤±è´¥:', error);
                    alert('ä¿®æ”¹æŠ•ç¥¨å¤±è´¥: ' + error.message);
                }
            }
        }

        // åˆ‡æ¢å…³æ³¨çŠ¶æ€ï¼ˆä½¿ç”¨çœŸå®APIï¼‰
        async function toggleInterest() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = './auth.html';
                return;
            }
            
            try {
                if (eventData.user_interested) {
                    await api.removeInterest(eventData.id);
                    eventData.user_interested = false;
                    eventData.interest_count--;
                    alert('å–æ¶ˆå…³æ³¨æˆåŠŸï¼');
                } else {
                    await api.addInterest(eventData.id);
                    eventData.user_interested = true;
                    eventData.interest_count++;
                    alert('å…³æ³¨æˆåŠŸï¼');
                }
                
                renderEvent();
                
            } catch (error) {
                if (error.message.includes('å·²ç»æ·»åŠ è¿‡')) {
                    // çŠ¶æ€ä¸åŒæ­¥ï¼Œé‡æ–°è·å–
                    eventData.user_interested = true;
                    renderEvent();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + error.message);
                }
            }
        }

        // åˆ†äº«äº‹ä»¶
        function shareEvent() {
            const url = window.location.href;
            const title = `çœŸç›¸ä¹‹é•œ - ${eventData.title}`;
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: eventData.description.substring(0, 100) + '...',
                    url: url
                });
            } else {
                // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(url).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºé“¾æ¥
                    prompt('è¯·å¤åˆ¶ä»¥ä¸‹é“¾æ¥:', url);
                });
            }
        }

        // è§¦å‘æ™ºèƒ½æ–°é—»åˆ†æ
        async function triggerNewsAnalysis() {
            if (!eventData) {
                alert('äº‹ä»¶æ•°æ®æœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•');
                return;
            }

            const analysisBtn = document.getElementById('analysis-btn');
            // å¯åŠ¨å‰çš„å‰ç½®æ¡ä»¶ï¼šå…³æ³¨äººæ•°>=10 æˆ– ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
            const isAdmin = !!(currentUser && currentUser.role === 'admin');
            const minInterest = Number(localStorage.getItem('tm_interest_threshold') || 10);
            const enoughInterest = Number(eventData.interest_count || 0) >= minInterest;
            const adminApproved = (eventData.status && eventData.status !== 'pending') || isAdmin;
            if (!enoughInterest && !adminApproved) {
                showToast(`è¯¥äº‹ä»¶å…³æ³¨äººæ•°ä¸è¶³${minInterest}ï¼Œä¸”æœªé€šè¿‡ç®¡ç†å‘˜å®¡æ ¸ï¼Œæš‚ä¸å¯åŠ¨AIåˆ†æã€‚`, 'warning');
                return;
            }
            // å¦‚æœå·²æœ‰è¿›è¡Œä¸­çš„ä¼šè¯æˆ–å·²æœ‰è¿›åº¦æ¡†ï¼Œåˆ™ä¸é‡å¤è§¦å‘
            const sessions = readAnalysisSessions();
            const existingProgress = document.getElementById(`progress-${eventData.id}`);
            if (sessions[eventData.id] || existingProgress) {
                showToast('è¯¥äº‹ä»¶AIåˆ†æå·²åœ¨è¿›è¡Œï¼Œå·²ä¸ºä½ æ¢å¤è¿›åº¦', 'warning');
                resumeAnalysisIfOngoing(eventData.id);
                return;
            }
            
            try {
                // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºä¸“ä¸šçš„åˆ†ææ¨¡å¼
                analysisBtn.disabled = true;
                analysisBtn.innerHTML = 'ğŸ§  AIåˆ†æè¿›è¡Œä¸­...';
                analysisBtn.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                analysisBtn.style.color = 'white';
                analysisBtn.style.transform = 'scale(0.98)';
                
                console.log(`ğŸš€ [äº‹ä»¶${eventData.id}] å¯åŠ¨ä¸“ä¸šAIåˆ†æ:`, eventData.title);
                
                // è°ƒç”¨æ™ºèƒ½åˆ†æAPI
                const result = await api.analyzeEvent(eventData.title, eventData.description, eventData.id);
                
                console.log('åˆ†æç»“æœ:', result);
                
                if (result.success) {
                    // æ˜¾ç¤ºçœŸæ­£çš„åˆ†æè¿›åº¦ç•Œé¢
                    showRealTimeAnalysisProgress(result);
                    analysisBtn.innerHTML = 'ğŸš€ åå°åˆ†æä¸­...';
                    analysisBtn.style.background = 'linear-gradient(45deg, #f59e0b, #d97706)';
                    showToast('AIåˆ†æå·²å¯åŠ¨ï¼Œæ­£åœ¨åå°è¿è¡Œ...', 'info');
                    
                    // å¯åŠ¨è¿›åº¦ç›‘æ§
                    startAnalysisProgressMonitor(result.event_id);
                    // è®°å½•æœ¬åœ°ä¼šè¯ï¼Œæ”¯æŒåˆ·æ–°æ¢å¤
                    saveAnalysisSession(result.event_id);
                } else {
                    const errorMsg = result.error || 'æœªçŸ¥é”™è¯¯';
                    console.error('AIåˆ†æå¤±è´¥:', errorMsg);
                    
                    // æ˜¾ç¤ºä¸“ä¸šçš„é”™è¯¯æç¤º
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                        color: white;
                        padding: 15px;
                        border-radius: 10px;
                        margin: 15px 0;
                    `;
                    errorDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 1.5em;">âš ï¸</div>
                            <div>
                                <div style="font-weight: bold;">AIåˆ†æå¤±è´¥</div>
                                <div style="font-size: 0.9em;">${errorMsg}</div>
                            </div>
                        </div>
                    `;
                    
                    const actionsDiv = document.querySelector('.actions');
                    if (actionsDiv) {
                        actionsDiv.appendChild(errorDiv);
                    } else {
                        const eventDetail = document.querySelector('.event-detail') || document.querySelector('.container');
                        if (eventDetail) {
                            eventDetail.appendChild(errorDiv);
                        }
                    }
                    analysisBtn.innerHTML = 'âŒ åˆ†æå¤±è´¥';
                    analysisBtn.style.background = 'linear-gradient(45deg, #ef4444, #dc2626)';
                }
                
            } catch (error) {
                console.error('æ™ºèƒ½åˆ†æå¤±è´¥:', error);
                showToast('æ™ºèƒ½åˆ†æå¤±è´¥: ' + error.message, 'error');
                analysisBtn.innerHTML = 'âŒ åˆ†æå¤±è´¥';
            } finally {
                // æŒ‰é’®çŠ¶æ€ç”±è¿›åº¦/å®Œæˆå›è°ƒæ§åˆ¶ï¼Œä¸åœ¨è¿™é‡Œæ¢å¤ï¼Œé¿å…é‡å¤ç‚¹å‡»
            }
        }

        // æ˜¾ç¤ºçœŸæ­£çš„AIåˆ†æè¿›åº¦
        function showRealTimeAnalysisProgress(result) {
            // è‹¥å·²å­˜åœ¨åŒäº‹ä»¶è¿›åº¦å¡ç‰‡ï¼Œå…ˆç§»é™¤ï¼Œé¿å…é‡å¤
            const existed = document.getElementById(`progress-${result.event_id}`);
            if (existed) existed.remove();
            // åˆ›å»ºè¿›åº¦æ˜¾ç¤ºåŒºåŸŸ
            const progressSection = document.createElement('div');
            progressSection.className = 'analysis-progress';
            progressSection.id = `progress-${result.event_id}`;
            progressSection.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                border-radius: 15px;
                margin: 20px 0;
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            `;
            
            progressSection.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div class="spinner" style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.4em;">ğŸ§  AIæ·±åº¦åˆ†ææ­£åœ¨è¿›è¡Œ</h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">äº‹ä»¶${result.event_id} | é¢„è®¡åˆ†ææ—¶é—´: 60-120ç§’</p>
                    </div>
                </div>
                
                <div class="progress-steps" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                    <h4 style="margin: 0 0 15px 0;">ğŸ“Š åˆ†ææµç¨‹è¿›åº¦</h4>
                    <div class="steps-container" id="steps-${result.event_id}">
                        <div class="step active">ğŸ” æ­¥éª¤1: æœç´¢ç›¸å…³æ–°é—»</div>
                        <div class="step">ğŸŒ æ­¥éª¤2: æ£€æµ‹è¿é€šæ€§</div>
                        <div class="step">ğŸ¤– æ­¥éª¤3: AIç›¸å…³æ€§ç­›é€‰</div>
                        <div class="step">ğŸ“„ æ­¥éª¤4: æŠ“å–ç½‘é¡µå†…å®¹</div>
                        <div class="step">ğŸ“ æ­¥éª¤5: æå–æ­£æ–‡ä¿¡æ¯</div>
                        <div class="step">ğŸ§  æ­¥éª¤6: GLM/DeepSeekæ·±åº¦åˆ†æ</div>
                        <div class="step">ğŸ“‹ æ­¥éª¤7: ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š</div>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 0.9em; opacity: 0.8;">
                        ğŸ’¡ æç¤º: å¯åœ¨åç«¯ç»ˆç«¯çª—å£æŸ¥çœ‹è¯¦ç»†çš„å®æ—¶æ—¥å¿—
                    </div>
                </div>
                
                <style>
                    .step {
                        padding: 8px 12px;
                        margin: 5px 0;
                        border-radius: 6px;
                        background: rgba(255,255,255,0.1);
                        opacity: 0.5;
                        transition: all 0.3s ease;
                    }
                    .step.active {
                        background: rgba(255,255,255,0.2);
                        opacity: 1;
                        border-left: 4px solid #10b981;
                    }
                    .step.completed {
                        background: rgba(16, 185, 129, 0.3);
                        opacity: 1;
                        border-left: 4px solid #10b981;
                    }
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            // æ’å…¥åˆ°äº‹ä»¶è¯¦æƒ…å
            const actionsDiv = document.querySelector('.actions');
            if (actionsDiv) {
                actionsDiv.appendChild(progressSection);
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°actionså®¹å™¨ï¼Œæ’å…¥åˆ°äº‹ä»¶è¯¦æƒ…åŒºåŸŸ
                const eventDetail = document.querySelector('.event-detail') || document.querySelector('.container');
                if (eventDetail) {
                    eventDetail.appendChild(progressSection);
                }
            }
        }

        // å¯åŠ¨åˆ†æè¿›åº¦ç›‘æ§
        async function startAnalysisProgressMonitor(eventId, startFromStep = 0) {
            let currentStep = startFromStep;
            const totalSteps = 7;
            const stepDuration = 1000; // è½®è¯¢æ›´åŠæ—¶
            const maxDuration = 3 * 60 * 1000; // 3åˆ†é’Ÿè¶…æ—¶
            const startTime = Date.now();
            let idlePolls = 0;

            const progressInterval = setInterval(async () => {
                try {
                    const status = await api.getAnalysisStatus(eventId);
                    if (status?.status === 'idle') {
                        idlePolls++;
                        if (idlePolls >= 3) {
                            clearInterval(progressInterval);
                            clearAnalysisSession(eventId);
                            showToast('æœªæ£€æµ‹åˆ°åå°ä»»åŠ¡ï¼Œå·²å–æ¶ˆï¼Œè¯·é‡æ–°å‘èµ·', 'warning');
                            const btn = document.getElementById('analysis-btn');
                            if (btn) { btn.disabled = false; btn.innerHTML = 'ğŸ¤– æ™ºèƒ½åˆ†æ'; }
                            return;
                        }
                    } else if (status?.status === 'started' || status?.status === 'running') {
                        // å°†åç«¯ step å­—æ®µæ˜ å°„åˆ°å‰ç«¯æ­¥éª¤åºå·
                        const stepMap = {
                            'step1_search': 1,
                            'step2_accessible': 2,
                            'step3_relevance': 3,
                            'step4_fetch_html': 4,
                            'step5_extract': 5,
                            'step6_ai': 6,
                            'step6_direct_ai_attempt': 6,
                            'step7_summary': 7
                        };
                        if (status.step && stepMap[status.step]) {
                            currentStep = Math.max(currentStep, stepMap[status.step]);
                        }

                        // ä¾æ®è®¡æ•°æ¨æ–­æ­¥éª¤ï¼ˆåç«¯æœªç»†åŒ–å†™å…¥æ—¶ä¹Ÿèƒ½å‰è¿›ï¼‰
                        if (typeof status.raw_count === 'number' && status.raw_count > 0) {
                            currentStep = Math.max(currentStep, 1);
                        }
                        if (typeof status.accessible === 'number' && status.accessible > 0) {
                            currentStep = Math.max(currentStep, 2);
                        }
                        if (typeof status.relevant === 'number' && status.relevant > 0) {
                            currentStep = Math.max(currentStep, 3);
                        }

                        // æ—¶é—´æ¨è¿›å…œåº•ï¼šé•¿æœŸæ— çŠ¶æ€æ›´æ–°æ—¶æŒ‰è€—æ—¶æ¨è¿›ï¼Œé¿å…å‰ç«¯åœç•™åœ¨ç¬¬ä¸€æ­¥
                        const startedAt = new Date(status.started_at || status?.analysis_statistics?.started_at || startTime).getTime();
                        const elapsed = Date.now() - startedAt;
                        const thresholds = [15000, 30000, 60000, 90000, 120000]; // 15sâ†’2, 30sâ†’3, 60sâ†’4, 90sâ†’5, 120sâ†’6
                        thresholds.forEach((t, idx) => {
                            if (elapsed >= t) currentStep = Math.max(currentStep, idx + 2);
                        });
                    } else if (status?.status === 'completed') {
                        updateProgressStep(eventId, totalSteps);
                        clearInterval(progressInterval);
                        // æ‹‰å–æœ€ç»ˆç»“æœå¹¶æ¸²æŸ“
                        try {
                            const finalRes = await api.getAnalysisResult(eventId);
                            if (finalRes?.success && finalRes.detailed_result) {
                                const resultPayload = {
                                    success: true,
                                    event_id: eventId,
                                    ai_analysis: {
                                        reliability: 'reliable',
                                        summary: finalRes.detailed_result.final_summary || 'ï¼ˆæ— æ‘˜è¦ï¼‰',
                                        analysis_statistics: finalRes.detailed_result.analysis_statistics || {},
                                        workflow_summary: finalRes.detailed_result.workflow_summary || {}
                                    },
                                    detailed_result: finalRes.detailed_result,
                                    timestamp: new Date().toISOString(),
                                    next_step: 'VOTING'
                                };
                                // ç¼“å­˜åˆ°æœ¬åœ°ï¼Œåˆ·æ–°å¯æ¢å¤
                                localStorage.setItem(`tm_ai_result_${eventId}`, JSON.stringify(resultPayload));
                                showAnalysisResult(resultPayload);
                            }
                        } catch (e) {}
                        showAnalysisCompleted(eventId);
                        clearAnalysisSession(eventId);
                        return;
                    } else if (status?.status === 'failed') {
                        clearInterval(progressInterval);
                        clearAnalysisSession(eventId);
                        showToast('AIåˆ†æå¤±è´¥ï¼š' + (status.error || status.step || 'æœªçŸ¥é”™è¯¯'), 'error');
                        const btn = document.getElementById('analysis-btn');
                        if (btn) { btn.disabled = false; btn.innerHTML = 'ğŸ¤– æ™ºèƒ½åˆ†æ'; }
                        return;
                    }

                    // å…œåº•ï¼šå³ä½¿çŠ¶æ€æœªåˆ° completedï¼Œä½†è‹¥åç«¯å·²ç”Ÿæˆç»“æœæ–‡ä»¶ï¼Œç›´æ¥æ‹‰å–å¹¶å®Œæˆ
                    try {
                        const maybeDone = await api.getAnalysisResult(eventId);
                        if (maybeDone?.success && maybeDone.detailed_result) {
                            updateProgressStep(eventId, totalSteps);
                            const resultPayload = {
                                success: true,
                                event_id: eventId,
                                ai_analysis: {
                                    reliability: 'reliable',
                                    summary: maybeDone.detailed_result.final_summary || 'ï¼ˆæ— æ‘˜è¦ï¼‰',
                                    analysis_statistics: maybeDone.detailed_result.analysis_statistics || {},
                                    workflow_summary: maybeDone.detailed_result.workflow_summary || {}
                                },
                                detailed_result: maybeDone.detailed_result,
                                timestamp: new Date().toISOString(),
                                next_step: 'VOTING'
                            };
                            localStorage.setItem(`tm_ai_result_${eventId}`, JSON.stringify(resultPayload));
                            showAnalysisResult(resultPayload);
                            showAnalysisCompleted(eventId);
                            clearAnalysisSession(eventId);
                            clearInterval(progressInterval);
                            return;
                        }
                    } catch (_) {}

                    // åŠ¨æ€æ˜¾ç¤ºæŠ“å–ç»Ÿè®¡
                    const stepsContainer = document.getElementById(`steps-${eventId}`);
                    if (stepsContainer && (status?.raw_count || status?.accessible || status?.relevant)) {
                        const s1 = stepsContainer.children[0];
                        const s2 = stepsContainer.children[1];
                        const s3 = stepsContainer.children[2];
                        if (s1 && typeof status.raw_count === 'number') s1.textContent = `ğŸ” æ­¥éª¤1: æœç´¢ç›¸å…³æ–°é—» (${status.raw_count})`;
                        if (s2 && typeof status.accessible === 'number') s2.textContent = `ğŸŒ æ­¥éª¤2: æ£€æµ‹è¿é€šæ€§ (${status.accessible})`;
                        if (s3 && typeof status.relevant === 'number') s3.textContent = `ğŸ¤– æ­¥éª¤3: AIç›¸å…³æ€§ç­›é€‰ (${status.relevant})`;
                    }
                } catch (e) {
                    // ç½‘ç»œå¼‚å¸¸æ—¶ä¿å®ˆæ¨è¿›ä¸€æ­¥
                    currentStep = Math.min(totalSteps, currentStep + 1);
                }

                if (Date.now() - startTime > maxDuration) {
                    clearInterval(progressInterval);
                    clearAnalysisSession(eventId);
                    showToast('AIåˆ†æè¶…æ—¶ï¼Œå·²åœæ­¢ã€‚è¯·ç¨åé‡è¯•ã€‚', 'warning');
                    const btn = document.getElementById('analysis-btn');
                    if (btn) { btn.disabled = false; btn.innerHTML = 'ğŸ¤– æ™ºèƒ½åˆ†æ'; }
                    return;
                }

                currentStep = Math.min(totalSteps, Math.max(1, currentStep));
                updateProgressStep(eventId, currentStep);
            }, stepDuration);

            window.progressIntervals = window.progressIntervals || {};
            window.progressIntervals[eventId] = progressInterval;
        }

        // æ›´æ–°è¿›åº¦æ­¥éª¤
        function updateProgressStep(eventId, stepNum) {
            const stepsContainer = document.getElementById(`steps-${eventId}`);
            if (stepsContainer) {
                const steps = stepsContainer.querySelectorAll('.step');
                
                // æ›´æ–°æ­¥éª¤çŠ¶æ€
                steps.forEach((step, index) => {
                    step.classList.remove('active');
                    if (index < stepNum - 1) {
                        step.classList.add('completed');
                    } else if (index === stepNum - 1) {
                        step.classList.add('active');
                    }
                });
            }
        }

        // æ˜¾ç¤ºåˆ†æå®ŒæˆçŠ¶æ€
        function showAnalysisCompleted(eventId) {
            const progressSection = document.getElementById(`progress-${eventId}`);
            if (progressSection) {
                progressSection.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">âœ…</div>
                        <h3 style="margin: 0 0 10px 0;">AIåˆ†æå®Œæˆï¼</h3>
                        <p style="margin: 0; opacity: 0.9;">
                            äº‹ä»¶${eventId}çš„æ·±åº¦åˆ†æå·²å®Œæˆï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹è¯¦ç»†çš„åˆ†ææŠ¥å‘Šå’Œå¯ä¿¡åº¦è¯„ä¼°ã€‚
                        </p>
                    </div>
                `;
                progressSection.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const analysisBtn = document.getElementById('analysis-btn');
            if (analysisBtn) {
                analysisBtn.innerHTML = 'âœ… åˆ†æå®Œæˆ';
                analysisBtn.style.background = 'linear-gradient(45deg, #10b981, #059669)';
                analysisBtn.disabled = false;
            }

            showToast('AIåˆ†æå®Œæˆ', 'success');
        }

        // æ˜¾ç¤ºä¸“ä¸šçš„AIåˆ†æç»“æœ
        function showAnalysisResult(result) {
            // å…ˆç§»é™¤ä¹‹å‰çš„åˆ†æç»“æœ
            const existingResult = document.querySelector('.analysis-result');
            if (existingResult) {
                existingResult.remove();
            }

            // åˆ›å»ºç»“æœæ˜¾ç¤ºåŒºåŸŸ
            const analysisSection = document.createElement('div');
            analysisSection.className = 'analysis-result';
            analysisSection.style.cssText = `
                background: rgba(16, 185, 129, 0.1);
                border: 1px solid rgba(16, 185, 129, 0.2);
                border-radius: 12px;
                padding: 20px;
                margin: 20px 0;
                backdrop-filter: blur(10px);
            `;
            
            // æ˜¾ç¤ºAIè¯„çº§
            const aiRating = result.ai_analysis?.reliability || 'unknown';
            const ratingColors = {
                'reliable': '#28a745',
                'questionable': '#ffc107', 
                'unreliable': '#dc3545',
                'insufficient': '#6c757d'
            };
            const ratingTexts = {
                'reliable': 'å¯é ',
                'questionable': 'å­˜ç–‘',
                'unreliable': 'ä¸å¯é ', 
                'insufficient': 'ä¿¡æ¯ä¸è¶³'
            };
            
            analysisSection.innerHTML = `
                <div class="analysis-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px 12px 0 0; color: white; margin: -20px -20px 20px -20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.5em;">ğŸ§  AIæ™ºèƒ½åˆ†ææŠ¥å‘Š</h3>
                            <p style="margin: 5px 0 0 0; opacity: 0.9;">åŸºäºGLM-4.5 & DeepSeekå¤šæ¨¡å‹æ·±åº¦åˆ†æ</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9em; opacity: 0.8;">åˆ†æå¼•æ“</div>
                            <div style="font-weight: bold;">Truth Mirror AI</div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-meta" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>ğŸ“‹ äº‹ä»¶ç¼–å·:</strong> ${result.event_id || 'N/A'}
                        </div>
                        <div>
                            <strong>ğŸ” åˆ†ææŸ¥è¯¢:</strong> ${result.query}
                        </div>
                        <div>
                            <strong>â° åˆ†ææ—¶é—´:</strong> ${new Date(result.timestamp).toLocaleString()}
                        </div>
                        <div>
                            <strong>ğŸ“Š å¤„ç†çŠ¶æ€:</strong> ${result.success ? 'âœ… åˆ†æå®Œæˆ' : 'âŒ åˆ†æå¤±è´¥'}
                        </div>
                    </div>
                </div>

                ${result.ai_analysis ? `
                    <div class="reliability-section" style="margin-bottom: 25px;">
                        <h4 style="color: #2d3748; margin-bottom: 15px;">ğŸ¯ AIå¯ä¿¡åº¦è¯„ä¼°</h4>
                        <div class="ai-rating" style="background: ${ratingColors[aiRating]}15; border: 2px solid ${ratingColors[aiRating]}40; border-radius: 10px; padding: 20px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: ${ratingColors[aiRating]};"></div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: ${ratingColors[aiRating]}; margin-bottom: 5px;">
                                        ${ratingTexts[aiRating]} (${aiRating.toUpperCase()})
                                    </div>
                                    <div style="color: #666; font-size: 0.9em;">åŸºäºå¤šç»´åº¦AIæ¨¡å‹äº¤å‰éªŒè¯ç»“æœ</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 2em; color: ${ratingColors[aiRating]};">
                                        ${aiRating === 'reliable' ? 'ğŸŸ¢' : aiRating === 'questionable' ? 'ğŸŸ¡' : aiRating === 'unreliable' ? 'ğŸ”´' : 'âšª'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                            </div>
                            <p><strong>ä¸‹ä¸€æ­¥:</strong> ${result.next_step === 'VOTING' ? 'ğŸ—³ï¸ è¿›å…¥æŠ•ç¥¨é˜¶æ®µ' : result.next_step}</p>
                        ` : ''}
                    </div>
                    
                    ${result.detailed_result ? `
                        <div class="analysis-details">
                            <h4>ğŸ“ è¯¦ç»†åˆ†æ</h4>
                            <div class="analysis-report" style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                ${result.detailed_result.final_summary || 'åˆ†ææŠ¥å‘Šç”Ÿæˆä¸­...'}
                            </div>
                            ${result.detailed_result.workflow_summary ? `
                                <div class="workflow-stats">
                                    <h5>ğŸ“ˆ å¤„ç†ç»Ÿè®¡</h5>
                                    <ul style="padding-left: 20px;">
                                        <li>åŸå§‹æ–°é—»: ${result.detailed_result.workflow_summary.step1_raw_news || 0} æ¡</li>
                                        <li>å¯è®¿é—®é“¾æ¥: ${result.detailed_result.workflow_summary.step2_accessible || 0} æ¡</li>
                                        <li>ç›¸å…³æ–°é—»: ${result.detailed_result.workflow_summary.step3_relevant || 0} æ¡</li>
                                        <li>å†…å®¹æå–: ${result.detailed_result.workflow_summary.step5_content_extracted || 0} æ¡</li>
                                        <li>AIåˆ†æ: ${result.detailed_result.workflow_summary.step6_analyzed || 0} æ¡</li>
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : '<p>æ­£åœ¨ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Š...</p>'}
                </div>
            `;

            // æ’å…¥åˆ°æ“ä½œæŒ‰é’®åŒºåŸŸä¹‹å‰
            const actionsSection = document.querySelector('.actions');
            if (actionsSection) {
                actionsSection.parentNode.insertBefore(analysisSection, actionsSection);
            } else {
                document.querySelector('.main-content').appendChild(analysisSection);
            }

            // æ»šåŠ¨åˆ°åˆ†æç»“æœ
            analysisSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('event-detail').innerHTML = `
                <div class="event-header">
                    <h1 class="event-title">è¿æ¥é”™è¯¯</h1>
                </div>
                <div class="event-content">
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">é‡æ–°åŠ è½½</button>
                    <a href="./index.html" class="btn">è¿”å›é¦–é¡µ</a>
                </div>
            `;
        }

        // ç®¡ç†å‘˜æ“ä½œï¼šå®¡æ ¸é€šè¿‡
        async function approveEvent() {
            if (!confirm('ç¡®å®šè¦å®¡æ ¸é€šè¿‡æ­¤äº‹ä»¶å—ï¼Ÿäº‹ä»¶å°†è¿›å…¥æåé˜¶æ®µã€‚')) {
                return;
            }

            try {
                const api = new TruthMirrorAPI();
                await api.apiCall(`/events/${eventData.id}/approve`, {
                    method: 'POST'
                });

                alert('äº‹ä»¶å®¡æ ¸é€šè¿‡ï¼å·²è¿›å…¥æåé˜¶æ®µã€‚');
                location.reload(); // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°çŠ¶æ€
            } catch (error) {
                alert('å®¡æ ¸å¤±è´¥: ' + error.message);
            }
        }

        // ç®¡ç†å‘˜æ“ä½œï¼šå¼€å§‹AIå¤„ç†
        async function startAIProcessing() {
            if (!confirm('ç¡®å®šè¦å¼€å§‹AIåˆ†æå—ï¼Ÿ')) {
                return;
            }

            try {
                const api = new TruthMirrorAPI();
                await api.apiCall(`/events/${eventData.id}/start-ai-processing`, {
                    method: 'POST'
                });

                alert('AIåˆ†æå·²å¼€å§‹ï¼');
                location.reload(); // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°çŠ¶æ€
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // AIåˆ†ææ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ

        // ç®¡ç†å‘˜æ“ä½œï¼šæŸ¥çœ‹æŠ•ç¥¨è¯¦æƒ…
        async function viewVoteDetails() {
            try {
                const api = new TruthMirrorAPI();

                // è·å–æŠ•ç¥¨ç»Ÿè®¡æ•°æ®
                const stats = await api.getVoteStats(eventData.id);

                // å¦‚æœæ²¡æœ‰ç»Ÿè®¡æ•°æ®ï¼Œä½¿ç”¨äº‹ä»¶æ•°æ®ä¸­çš„æŠ•ç¥¨ä¿¡æ¯
                const totalVotes = stats?.total_votes || eventData.vote_count || 0;
                const supportVotes = stats?.support_votes || eventData.support_votes || 0;
                const opposeVotes = stats?.oppose_votes || eventData.oppose_votes || 0;
                const supportPercentage = totalVotes > 0 ? ((supportVotes / totalVotes) * 100).toFixed(1) : 0;
                const opposePercentage = totalVotes > 0 ? ((opposeVotes / totalVotes) * 100).toFixed(1) : 0;

                const message = `æŠ•ç¥¨è¯¦æƒ…ï¼š
æ€»æŠ•ç¥¨æ•°ï¼š${totalVotes}
è®¤åŒç¥¨ï¼š${supportVotes} (${supportPercentage}%)
ä¸è®¤åŒç¥¨ï¼š${opposeVotes} (${opposePercentage}%)`;

                alert(message);
            } catch (error) {
                console.error('è·å–æŠ•ç¥¨è¯¦æƒ…å¤±è´¥:', error);

                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨äº‹ä»¶æ•°æ®ä¸­çš„æŠ•ç¥¨ä¿¡æ¯ä½œä¸ºå¤‡é€‰
                const totalVotes = eventData.vote_count || 0;
                const supportVotes = eventData.support_votes || 0;
                const opposeVotes = eventData.oppose_votes || 0;
                const supportPercentage = totalVotes > 0 ? ((supportVotes / totalVotes) * 100).toFixed(1) : 0;
                const opposePercentage = totalVotes > 0 ? ((opposeVotes / totalVotes) * 100).toFixed(1) : 0;

                const message = `æŠ•ç¥¨è¯¦æƒ…ï¼š
æ€»æŠ•ç¥¨æ•°ï¼š${totalVotes}
è®¤åŒç¥¨ï¼š${supportVotes} (${supportPercentage}%)
ä¸è®¤åŒç¥¨ï¼š${opposeVotes} (${opposePercentage}%)`;

                alert(message);
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>